name: CI - Build CUDA Wheels

on:
  pull_request:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  cuda-wheels:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            arch: amd64
          - os: ubuntu-24.04-arm
            arch: arm64

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      # -----------------------
      # ARM64: build in Docker
      # -----------------------
      - name: Build wheel in Docker (ARM64)
        if: matrix.arch == 'arm64'
        run: |
          cd kv_connectors/llmd_fs_backend
          DOCKER_BUILDKIT=1 docker build \
            --platform=linux/arm64 \
            --build-arg CUDA_VERSION=12.9.1 \
            --build-arg torch_cuda_arch_list='8.7 8.9 9.0 10.0+PTX' \
            --build-arg max_jobs=4 \
            --tag llmd-fs-backend:build \
            --target build \
            --progress plain \
            -f Dockerfile.wheel .

          mkdir -p wheels
          docker run --rm -v $(pwd)/wheels:/artifacts_host llmd-fs-backend:build \
            bash -lc 'cp -r dist/* /artifacts_host/ && chmod -R a+rw /artifacts_host'

          ls -lh wheels/

      # -----------------------
      # AMD64: build natively
      # -----------------------
      - name: Set up Python (AMD64)
        if: matrix.arch == 'amd64'
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install system deps (AMD64)
        if: matrix.arch == 'amd64'
        run: |
          sudo apt-get update
          sudo apt-get install -y libnuma-dev

      - name: Install CUDA toolkit 12.8 (AMD64)
        if: matrix.arch == 'amd64'
        shell: bash
        run: |
          wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-keyring_1.1-1_all.deb
          sudo dpkg -i cuda-keyring_1.1-1_all.deb
          sudo apt-get update
          sudo apt-get install -y cuda-toolkit-12-8
          #  Set CUDA environment
          echo "CUDA_HOME=/usr/local/cuda" >> $GITHUB_ENV
          echo "/usr/local/cuda/bin" >> $GITHUB_PATH

      - name: Build wheel natively (AMD64)
        if: matrix.arch == 'amd64'
        working-directory: kv_connectors/llmd_fs_backend
        env:
          CUDA_HOME: /usr/local/cuda
          TORCH_CUDA_ARCH_LIST: "7.0;7.5;8.0;8.6;8.9;9.0+PTX"
        run: |
          python -m pip install -U pip setuptools wheel build ninja numpy
          python -m pip --no-cache-dir install torch==2.9.1

          # Clean build artifacts
          rm -rf build dist *.egg-info wheels
          find . -name "*.so" -delete || true

          mkdir -p wheels
          make wheel
          ls -lh wheels/

      # -----------------------
      # Upload artifacts
      # -----------------------
      - name: Upload wheels as workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: cuda-wheels-${{ matrix.arch }}
          path: kv_connectors/llmd_fs_backend/wheels/*.whl
