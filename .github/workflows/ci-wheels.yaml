name: CI - Build CUDA Wheels

on:
  pull_request:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  cuda-wheels:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            arch: amd64
          - os: ubuntu-24.04-arm
            arch: arm64

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Build wheel in Docker
        run: |
          cd kv_connectors/llmd_fs_backend

          if [[ "${{ matrix.arch }}" == "arm64" ]]; then
            PLATFORM="linux/arm64"
          else
            PLATFORM="linux/amd64"
          fi

          DOCKER_BUILDKIT=1 docker build \
            --platform=${PLATFORM} \
            --build-arg CUDA_VERSION=12.9.1 \
            --build-arg torch_cuda_arch_list='8.7 8.9 9.0 10.0+PTX' \
            --build-arg max_jobs=4 \
            --tag llmd-fs-backend:build-${{ matrix.arch }} \
            --target build \
            --progress plain \
            -f Dockerfile.wheel .

          mkdir -p wheels
          docker run --rm -v $(pwd)/wheels:/artifacts_host llmd-fs-backend:build-${{ matrix.arch }} \
            bash -lc 'cp -r dist/* /artifacts_host/ && chmod -R a+rw /artifacts_host'

          ls -lh wheels/

      # -----------------------
      # Upload artifacts
      # -----------------------
      - name: Upload wheels as workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: cuda-wheels-${{ matrix.arch }}
          path: kv_connectors/llmd_fs_backend/wheels/*.whl
